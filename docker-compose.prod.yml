services:
  frontend:
    env_file:
      - .env
    build:
      context: ./frontend/
      dockerfile: Dockerfile.prod
      args:
        REACT_APP_HOST: ${REACT_APP_HOST}
        REACT_APP_STRIPE_PUBLIC_KEY: ${REACT_APP_STRIPE_PUBLIC_KEY}

  astro:
    build:
      context: ./astro/
      dockerfile: Dockerfile.prod
      args:
        PUBLIC_ASTRO_DOMAIN: ${PUBLIC_ASTRO_DOMAIN}
        PUBLIC_STRIPE_PUBLIC_KEY: ${PUBLIC_STRIPE_PUBLIC_KEY}
    env_file:
      - .env

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  db:
    image: postgres:17
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "psql", "-U", "postgres", "-c", "SELECT 1"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  migrate:
    env_file:
      - .env
    build:
      context: ./backend/
      dockerfile: Dockerfile
    entrypoint: /usr/local/bin/migrate-entrypoint.sh
    volumes:
      - ./backend:/code/
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

  backend:
    env_file:
      - .env
    build:
      context: ./backend/
      dockerfile: Dockerfile
    entrypoint: null
    command: gunicorn backend.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./backend:/code/
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

  celery_worker:
    env_file:
      - .env
    build:
      context: ./backend/
      dockerfile: Dockerfile
    command: celery -A backend worker -l info
    volumes:
      - ./backend:/code/
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    entrypoint: null

  celery_beat:
    env_file:
      - .env
    build:
      context: ./backend/
      dockerfile: Dockerfile
    command: celery -A backend beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ./backend:/code/
    depends_on:
      migrate:
        condition: service_completed_successfully
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    entrypoint: null

  # proxy:
  #   image: traefik:v3.4
  #   ports:
  #     - ${HTTP_PORT:-80}:80
  #     - ${HTTPS_PORT:-443}:443
  #   volumes:
  #     - ./traefik.toml:/etc/traefik/traefik.toml:ro
  #     - ./dynamic_conf.toml:/etc/traefik/dynamic_conf.toml:ro
  #     - ./acme.json:/acme.json
  #   env_file:
  #     - .env

volumes:
  postgres_data:
  redis_data:
